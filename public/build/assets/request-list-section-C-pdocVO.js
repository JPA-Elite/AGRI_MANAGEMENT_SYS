import{c as Q,I as P,a as A,J as W,K as H,u as K,r as h,s as q,j as e}from"./app-CsQBl0No.js";import{S as R}from"./sweetalert2.esm.all-BY1s0Tb6.js";import{a as J}from"./beneficiary-thunk-CAw1LSLm.js";import{R as u}from"./general-DOL9TG6R.js";import{F as U}from"./XMarkIcon-fv0RYCJP.js";import{z as V}from"./transition-BK6O8DPq.js";import{y as N}from"./dialog-ArFbwTbi.js";import{h as O}from"./moment-C5S46NFB.js";import{S as G}from"./spinner-C8UO7pbt.js";import"./use-server-handoff-complete-B-EwfRb9.js";import"./use-tab-direction-DsIobwLg.js";const E=Q("request/getAllRequests",async(p,{dispatch:c})=>{try{c(P(!0));const a=await A.get("/api/beneficiary-requests");c(W(a.data))}catch(a){c(H(a.message))}finally{c(P(!1))}});function X({isOpen:p,setIsOpen:c,onRequestAdded:a}){var B,D,z,L;const{beneficiaries:d,loading:y}=K(s=>s.beneficiary),[t,n]=h.useState({beneficiary_id:"",request_type:"",category:"",specific_type:"",purpose:"",requested_date:"",remarks:"",unit:"",schedule:""}),[f,C]=h.useState(null),[j,g]=h.useState([]);h.useEffect(()=>{p&&(q.dispatch(J()),console.log("Beneficiaries data:",d==null?void 0:d.data))},[p]);const r=s=>{var o;const l=(o=d==null?void 0:d.data)==null?void 0:o.find(m=>m.id===parseInt(s));C(l),n({...t,beneficiary_id:s,request_type:"",category:"",specific_type:""})},b=s=>{const l=x();n({...t,category:s,specific_type:"",request_type:l}),g([])},v=s=>{n({...t,specific_type:s}),g([])},w=async s=>{var l,o;s.preventDefault();try{const m=k(),i=u[m],S=i==null?void 0:i.categories.find(_=>_.name===t.category),T={...t,request_type:x(),requested_date:t.requested_date,status:"pending",tools:j.map(_=>{var M;const F=(M=i==null?void 0:i.tools[t.specific_type])==null?void 0:M.find(I=>I.name===_);return{name:_,type:(F==null?void 0:F.type)||"",category:t.category,specific_type:t.specific_type}}),request_context:{category_info:S,beneficiary_type:i==null?void 0:i.type,schedule_options:i==null?void 0:i.schedule_options}};x()==="farmer"&&t.category==="Fertilizer"||delete T.unit,x()!=="farmworker"&&delete T.schedule;const Z=await A.post("/api/beneficiary-requests",T);c(!1),a(),R.fire({title:"Success!",text:"Request has been submitted successfully",icon:"success",timer:1500})}catch(m){console.error("Submit error:",m),R.fire({title:"Error!",text:((o=(l=m.response)==null?void 0:l.data)==null?void 0:o.message)||"Failed to submit request. Please try again.",icon:"error"})}},x=()=>{var o;if(!((o=f==null?void 0:f.farm_profile)!=null&&o.main_livelihood))return null;const s=f.farm_profile.main_livelihood.toLowerCase();if(s.includes("farmworker")||s.includes("laborer"))return"farmworker/laborer";const l=Object.entries(u).find(([m,i])=>s.includes(i.type.toLowerCase()));return l?l[1].type:null},k=()=>{var l;const s=x();return s?s==="farmworker/laborer"?"FARMWORKER":((l=Object.entries(u).find(([o,m])=>m.type===s))==null?void 0:l[0])||null:null},$=()=>{var o,m,i,S;const s=k(),l=t.specific_type;return console.log("Tool lookup:",{beneficiaryKey:s,specificType:l,toolsData:(o=u[s])==null?void 0:o.tools}),!s||!l||!((m=u[s])!=null&&m.tools)?[]:(console.log("data: ",(i=u[s])==null?void 0:i.tools["Habitat Restoration"]),((S=u[s])==null?void 0:S.tools[l])||[])};return e.jsx(V,{show:p,as:h.Fragment,children:e.jsxs(N,{onClose:()=>c(!1),className:"relative z-50",children:[e.jsx("div",{className:"fixed inset-0 bg-black/30","aria-hidden":"true"}),e.jsx("div",{className:"fixed inset-0 flex items-start justify-center p-4 overflow-y-auto",children:e.jsx("div",{className:"min-h-full flex items-center w-full",children:e.jsxs(N.Panel,{className:"mx-auto w-full max-w-6xl rounded-lg bg-white p-6 shadow-xl my-8",children:[e.jsxs("div",{className:"sticky top-0 bg-white border-b pb-4 mb-4",children:[e.jsx(N.Title,{className:"text-lg font-medium",children:"Add New Request"}),e.jsx("button",{onClick:()=>c(!1),className:"absolute top-4 right-4",children:e.jsx(U,{className:"h-6 w-6 text-gray-500"})})]}),e.jsx("div",{className:"max-h-[calc(100vh-16rem)] overflow-y-auto pr-2",children:e.jsxs("form",{id:"requestForm",onSubmit:w,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Select Beneficiary"}),e.jsxs("select",{value:t.beneficiary_id,onChange:s=>r(s.target.value),required:!0,className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500",disabled:y,children:[e.jsx("option",{value:"",children:"Select Beneficiary"}),(B=d==null?void 0:d.data)==null?void 0:B.map(s=>{var l;return e.jsxs("option",{value:s.id,children:[s.firstname," ",s.lastname," - ",(l=s.farm_profile)==null?void 0:l.main_livelihood]},s.id)})]}),y&&e.jsx("span",{className:"text-sm text-gray-500",children:"Loading beneficiaries..."})]}),f&&x()&&e.jsxs("div",{className:"space-y-6 border-t pt-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Category"}),e.jsxs("select",{value:t.category,onChange:s=>b(s.target.value),required:!0,className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500",children:[e.jsx("option",{value:"",children:"Select Category"}),(D=u[k()])==null?void 0:D.categories.map(s=>e.jsx("option",{value:s.name,children:s.name},s.name))]})]}),t.category&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Specific Type"}),e.jsxs("select",{value:t.specific_type,onChange:s=>v(s.target.value),required:!0,className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500",children:[e.jsx("option",{value:"",children:"Select Type"}),(L=(z=u[k()])==null?void 0:z.categories.find(s=>s.name===t.category))==null?void 0:L.specific.map(s=>e.jsx("option",{value:s,children:s},s))]})]}),x()==="farmer"&&t.category==="Fertilizer"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Quantity Unit"}),e.jsxs("select",{value:t.unit,onChange:s=>n({...t,unit:s.target.value}),required:!0,className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500",children:[e.jsx("option",{value:"",children:"Select Unit"}),u.FARMER.quantities.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]})]}),x()==="farmworker"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Preferred Schedule"}),e.jsxs("select",{value:t.schedule,onChange:s=>n({...t,schedule:s.target.value}),required:!0,className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500",children:[e.jsx("option",{value:"",children:"Select Schedule"}),u.WORKER.schedule_options.map(s=>e.jsx("option",{value:s,children:s},s))]})]})]}),t.specific_type&&e.jsxs("div",{className:"space-y-6 border-t pt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Select Required Tools/Equipment"}),e.jsx("div",{className:"grid grid-cols-3 gap-4",children:($()||[]).map(s=>e.jsx("div",{className:"border rounded-lg p-3 hover:bg-gray-50",children:e.jsxs("label",{className:"flex items-start space-x-3 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:j.includes(s.name),onChange:l=>{l.target.checked?g([...j,s.name]):g(j.filter(o=>o!==s.name))},className:"mt-1 h-4 w-4 text-green-600 border-gray-300 rounded"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:s.name}),e.jsx("p",{className:"text-sm text-gray-500",children:s.type})]})]})},s.name))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Purpose"}),e.jsx("textarea",{value:t.purpose,onChange:s=>n({...t,purpose:s.target.value}),required:!0,className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500",rows:3})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Requested Date"}),e.jsx("input",{type:"date",value:t.requested_date,onChange:s=>n({...t,requested_date:s.target.value}),required:!0,className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Remarks"}),e.jsx("textarea",{value:t.remarks,onChange:s=>n({...t,remarks:s.target.value}),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500",rows:2})]})]})}),e.jsx("div",{className:"sticky bottom-0 bg-white pt-4 mt-6 border-t",children:e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{type:"button",onClick:()=>c(!1),className:"rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{type:"submit",form:"requestForm",className:"rounded-md bg-green-600 px-4 py-2 text-sm font-medium text-white hover:bg-green-500",children:"Submit Request"})]})})]})})})]})})}function Y({isOpen:p,setIsOpen:c,data:a,onStatusUpdate:d}){if(!a)return null;const y=()=>e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Status"}),e.jsx("div",{className:"mt-2 flex items-center gap-2",children:e.jsx("span",{className:`inline-flex rounded-full px-2 text-xs font-semibold leading-5 ${a.status==="approved"?"bg-green-100 text-green-800":a.status==="rejected"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:a.status})})]});return e.jsx(V,{show:p,as:h.Fragment,children:e.jsxs(N,{onClose:()=>c(!1),className:"relative z-50",children:[e.jsx("div",{className:"fixed inset-0 bg-black/30","aria-hidden":"true"}),e.jsx("div",{className:"fixed inset-0 flex items-start justify-center p-4 overflow-y-auto",children:e.jsx("div",{className:"min-h-full flex items-center w-full",children:e.jsxs(N.Panel,{className:"mx-auto w-full max-w-4xl rounded-lg bg-white p-8 shadow-xl",children:[e.jsxs("div",{className:"border-b pb-4 mb-4",children:[e.jsx(N.Title,{className:"text-lg font-medium",children:"Request Details"}),e.jsx("button",{onClick:()=>c(!1),className:"absolute top-4 right-4",children:e.jsx(U,{className:"h-6 w-6 text-gray-500"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Beneficiary"}),e.jsxs("p",{className:"mt-1",children:[a.beneficiary.firstname," ",a.beneficiary.lastname]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Request Type"}),e.jsx("p",{className:"mt-1 capitalize",children:a.request_type})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Category"}),e.jsx("p",{className:"mt-1",children:a.category})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Specific Type"}),e.jsx("p",{className:"mt-1",children:a.specific_type})]}),a.unit&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Unit"}),e.jsx("p",{className:"mt-1 capitalize",children:a.unit})]}),a.schedule&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Schedule"}),e.jsx("p",{className:"mt-1",children:a.schedule})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Selected Tools"}),a.tools&&a.tools.length>0?e.jsx("div",{className:"mt-2 grid grid-cols-2 gap-3",children:a.tools.map((t,n)=>e.jsxs("div",{className:"border rounded-lg p-3",children:[e.jsx("p",{className:"font-medium text-gray-900",children:t.name}),e.jsx("p",{className:"text-sm text-gray-500",children:t.type})]},n))}):e.jsx("p",{className:"mt-1 text-gray-500",children:"No tools selected"})]}),y()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Purpose"}),e.jsx("p",{className:"mt-1",children:a.purpose})]}),a.remarks&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Remarks"}),e.jsx("p",{className:"mt-1",children:a.remarks})]})]})]})})})]})})}function me(){var g;const[p,c]=h.useState(!1),[a,d]=h.useState(!1),[y,t]=h.useState(null),{requests:n,loading:f}=K(r=>r.request),C=r=>{t(r),d(!0)},j=async(r,b)=>{var v,w;try{await A.put(`/api/beneficiary-requests/${r}/status`,{status:b}),q.dispatch(E()),R.fire({title:"Success!",text:`Request status updated to ${b}`,icon:"success",timer:1500})}catch(x){console.error("Status update error:",x),R.fire({title:"Error!",text:((w=(v=x.response)==null?void 0:v.data)==null?void 0:w.message)||"Failed to update status",icon:"error"})}};return h.useEffect(()=>{q.dispatch(E())},[]),f?e.jsxs("div",{className:"flex items-center justify-center min-h-screen",children:[e.jsx(G,{size:"h-8 w-8",color:"text-green-500"}),e.jsx("span",{className:"ml-2",children:"Loading..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(X,{isOpen:p,setIsOpen:c,onRequestAdded:()=>q.dispatch(E())}),e.jsx(Y,{isOpen:a,setIsOpen:d,data:y}),e.jsxs("div",{className:"px-4 sm:px-6 lg:px-8",children:[e.jsxs("div",{className:"sm:flex sm:items-center",children:[e.jsxs("div",{className:"sm:flex-auto",children:[e.jsx("h1",{className:"text-base font-semibold text-gray-900",children:"Beneficiary Requests"}),e.jsx("p",{className:"mt-2 text-sm text-gray-700",children:"List of all requests from beneficiaries"})]}),e.jsx("div",{className:"mt-4 sm:ml-16 sm:mt-0 sm:flex-none",children:e.jsx("button",{onClick:()=>c(!0),className:"block rounded-md bg-green-600 px-3 py-2 text-center text-sm font-semibold text-white shadow-sm hover:bg-green-500",children:"Add Request"})})]}),e.jsx("div",{className:"mt-8 flow-root",children:e.jsx("div",{className:"-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8",children:e.jsx("div",{className:"inline-block min-w-full py-2 align-middle",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-300",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-3.5 text-left text-sm font-semibold text-gray-900",children:"Beneficiary"}),e.jsx("th",{className:"px-3 py-3.5 text-left text-sm font-semibold text-gray-900",children:"Type"}),e.jsx("th",{className:"px-3 py-3.5 text-left text-sm font-semibold text-gray-900",children:"Category"}),e.jsx("th",{className:"px-3 py-3.5 text-left text-sm font-semibold text-gray-900",children:"Request"}),e.jsx("th",{className:"px-3 py-3.5 text-left text-sm font-semibold text-gray-900",children:"Date"}),e.jsx("th",{className:"px-3 py-3.5 text-left text-sm font-semibold text-gray-900",children:"Status"}),e.jsx("th",{className:"px-3 py-3.5 text-center text-sm font-semibold text-gray-900",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:(g=n==null?void 0:n.data)==null?void 0:g.map(r=>e.jsxs("tr",{children:[e.jsxs("td",{className:"whitespace-nowrap px-3 py-4 text-sm text-gray-900",children:[r.beneficiary.firstname," ",r.beneficiary.lastname]}),e.jsx("td",{className:"whitespace-nowrap px-3 py-4 text-sm text-gray-900",children:r.request_type}),e.jsx("td",{className:"whitespace-nowrap px-3 py-4 text-sm text-gray-900",children:r.category}),e.jsx("td",{className:"whitespace-nowrap px-3 py-4 text-sm text-gray-900",children:r.specific_type}),e.jsx("td",{className:"whitespace-nowrap px-3 py-4 text-sm text-gray-900",children:O(r.requested_date).format("LL")}),e.jsx("td",{className:"whitespace-nowrap px-3 py-4 text-sm text-gray-900",children:e.jsxs("select",{value:r.status,onChange:b=>j(r.id,b.target.value),disabled:r.status!=="pending",className:`rounded-full px-2 py-1 text-xs font-semibold cursor-${r.status==="pending"?"pointer":"not-allowed"} ${r.status==="approved"?"bg-green-100 text-green-800":r.status==="rejected"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:[e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"approved",children:"Approved"}),e.jsx("option",{value:"rejected",children:"Rejected"})]})}),e.jsx("td",{className:"whitespace-nowrap px-3 py-4 text-sm text-center",children:e.jsx("button",{onClick:()=>C(r),className:"text-indigo-600 hover:text-indigo-900",children:"View Details"})})]},r.id))})]})})})})]})]})}export{me as default};
